//add row
function addService() {
    const servicesDiv = document.getElementById("services");
    const newRow = document.createElement("div");
    newRow.className = "service-row fade-in";
    newRow.innerHTML = `
                    <div class="service-row fade-in">
                <div class="input-group">
                    <input type="text" name="description[]" required placeholder=" ">
                    <label>Descrição</label>
                </div>
                <div class="input-group">
                    <input type="text" name="maintenance_type[]" required placeholder=" ">
                    <label>Tipo de Manutenção</label>
                </div>
                <div class="input-group">
                    <input type="number" name="price[]" required step="0.001" placeholder=" "  minlength="1" maxlength="5">
                    <label>Preço</label>
                </div>
            </div>
    `;
    servicesDiv.appendChild(newRow);
}
//print quotation
function printQuotation () {
    window.print();
}

//save quotation
document.getElementById("quotationForm").addEventListener("submit", function (e) {
    e.preventDefault();
    const formData = new FormData(this);

    fetch("php/save_quotation.php", {
        method: "POST",
        body: formData,
    })
    .then((response) => response.text())
    .then((data) => {
        alert(data);
        this.reset();
    })
    .catch((error) => {
        console.error("Error:", error);
    });
});



//save to pdf 
function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.text("Service Quotation", 10, 10);
    let y = 20;
    let total = 0;

    const rows = document.querySelectorAll('.service-row');
    rows.forEach((row, index) => {
        const desc = row.querySelector('input[name="description[]"]').value;
        const type = row.querySelector('input[name="maintenance_type[]"]').value;
        const price = parseFloat(row.querySelector('input[name="price[]"]').value);

        if (!isNaN(price)) total += price;

        // Corrigido a formatação do texto
        doc.text(`index + 1.{desc} | type |{price.toFixed(2)} MZN`, 10, y);
        y += 10;
    });

    // Adiciona total no final
    y += 10;
    doc.setFont("helvetica", "bold");
    doc.text(`Total: ${total.toLocaleString('pt-MZ', { style: 'currency', currency: 'MZN' })}`, 10, y);

    doc.save("quotation.esafe.pdf");
}


//export to csv(excel)

function exportToExcel() {
    let csv = "Descricao,Tipo de Manutencao,Preco\n"; // Definição do cabeçalho da tabela CSV
    const rows = document.querySelectorAll('.service-row');
    
    rows.forEach(row => {
        const desc = row.querySelector('input[name="description[]"]').value;
        const type = row.querySelector('input[name="maintenance_type[]"]').value;
        const price = row.querySelector('input[name="price[]"]').value;

        // Adicionando os valores ao CSV
        csv += `${desc},${type},${price}\n`; // Corrigido para interpolação de variáveis e uso correto do '\n' para nova linha
    });

    // Criar o Blob com os dados CSV e definir o tipo do arquivo
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    
    // Criando um link temporário para download
    link.href = URL.createObjectURL(blob);
    link.download = "quotation.esafe.csv"; // Definição do nome do arquivo
    link.click(); // Simula o clique para o download
}

// calcula total
// Função para formatar o valor como moeda


// Função para atualizar o total
function updateTotal() {
    let total = 0;
    const prices = document.querySelectorAll('input[name="price[]"]');
    
    // Loop para somar todos os preços válidos
    prices.forEach(input => {
        const val = parseFloat(input.value);
        if (!isNaN(val) && val > 0) total += val; // Somar somente valores válidos e positivos
    });

    // Atualizar o valor total na interface
    const totalValueElement = document.getElementById('totalValue');
    if (total > 0) {
        totalValueElement.innerText = formatCurrency(total); // Mostrar total formatado
    } else {
        totalValueElement.innerText = "0.00 MZN"; // Exibir mensagem caso o total seja 0 ou inválido
    }
}

// Função para formatar um valor como moeda (MZN)
function formatCurrency(value) {
    // Verifica se o valor é um número válido
    if (isNaN(value) || value === null) {
        return "Valor inválido"; // Retorna uma mensagem ou valor padrão para entradas inválidas
    }

    // Converte o valor para número se for uma string numérica
    value = parseFloat(value);

    // Formata o número como moeda (MZN)
    return value.toLocaleString('pt-MZ', { style: 'currency', currency: 'MZN' });
}

// Atualizar total ao digitar
document.addEventListener('input', function(e) {
    if (e.target.name === 'price[]') {
        updateTotal();
    }
});